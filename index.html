<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bybit — Trading Analyzer (Vanilla JS + Tailwind)</title>
  <!-- Tailwind CDN (for quick prototype) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex items-center justify-center p-6">
  <main class="max-w-4xl w-full bg-slate-800/60 backdrop-blur rounded-2xl shadow-2xl p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Bybit Trading Analyzer</h1>
        <p class="text-slate-300 text-sm">Vanilla HTML/CSS/JS prototype — Tailwind for styling. Not financial advice.</p>
      </div>
      <div class="text-right text-xs text-slate-400">Prototype • Client-side only</div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Inputs -->
      <div class="space-y-4">
        <label class="block">
          <span class="text-slate-300">Market</span>
          <select id="market" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2">
            <option value="spot">Spot</option>
            <option value="usdt_perp">USDT Perpetual</option>
            <option value="inverse_perp">Inverse Perpetual</option>
          </select>
        </label>

        <label class="block">
          <span class="text-slate-300">Symbol</span>
          <input id="symbol" placeholder="e.g. BTCUSDT" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
        </label>

        <label class="block">
          <span class="text-slate-300">Timeframe</span>
          <select id="timeframe" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2">
            <option>1m</option>
            <option>5m</option>
            <option>15m</option>
            <option>1h</option>
            <option>4h</option>
            <option>1d</option>
          </select>
        </label>

        <label class="block">
          <span class="text-slate-300">Entry time</span>
          <input id="entryTime" type="datetime-local" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
        </label>

        <label class="block">
          <span class="text-slate-300">Exit time</span>
          <input id="exitTime" type="datetime-local" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
        </label>

        <label class="block">
          <span class="text-slate-300">Entry price (optional)</span>
          <input id="entryPrice" type="number" step="any" placeholder="e.g. 45000" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
        </label>

        <label class="block">
          <span class="text-slate-300">Exit price (optional)</span>
          <input id="exitPrice" type="number" step="any" placeholder="e.g. 45200" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
        </label>

      </div>

      <!-- Controls & output -->
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-2">
          <button id="analyzeBtn" class="py-2 px-3 bg-emerald-500 text-slate-900 rounded-md font-medium hover:opacity-90">Analyze</button>
          <button id="clearBtn" class="py-2 px-3 bg-slate-600 text-slate-200 rounded-md hover:opacity-90">Clear</button>
        </div>

        <div class="p-4 rounded-lg bg-slate-700/40 border border-slate-600 min-h-[160px]" id="results">
          <h3 class="text-lg font-semibold">AI Answer</h3>
          <div id="aiAnswer" class="mt-2 text-slate-200 text-sm">Enter inputs and click <strong>Analyze</strong>.</div>
        </div>

        <div class="p-4 rounded-lg bg-slate-700/40 border border-slate-600">
          <h4 class="text-sm text-slate-400">Quick metrics</h4>
          <ul id="metrics" class="mt-2 text-sm text-slate-200 space-y-1">
            <li>Duration: —</li>
            <li>Potential P/L: —</li>
            <li>Risk / Reward: —</li>
          </ul>
        </div>

        <details class="p-3 rounded-md bg-slate-800 border border-slate-700 text-slate-300 text-sm">
          <summary class="cursor-pointer">Advanced (optional)</summary>
          <div class="mt-2 space-y-2">
            <label class="block">
              <span class="text-slate-300 text-xs">Position size (USD)</span>
              <input id="sizeUsd" type="number" step="any" placeholder="e.g. 100" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
            </label>
            <label class="block">
              <span class="text-slate-300 text-xs">Stop price (optional)</span>
              <input id="stopPrice" type="number" step="any" placeholder="e.g. 44000" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
            </label>
            <label class="block">
              <span class="text-slate-300 text-xs">Take profit (optional)</span>
              <input id="tpPrice" type="number" step="any" placeholder="e.g. 47000" class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
            </label>
            <p class="text-xs text-amber-300">Tip: You can optionally paste an OpenAI API key below to have the page request a more detailed, natural-language analysis. (Client-side keys are visible in the browser — for production use a server.)</p>
            <label class="block">
              <span class="text-slate-300 text-xs">OpenAI API Key (optional)</span>
              <input id="openAiKey" type="password" placeholder="sk-..." class="mt-1 block w-full rounded-md bg-slate-700/50 border border-slate-600 p-2" />
            </label>
          </div>
        </details>

      </div>
    </section>

    <footer class="mt-6 text-xs text-slate-400">Built with vanilla JS + Tailwind. Remember: this is a prototype, not financial advice.</footer>
  </main>

  <script>
    // Simple analyzer logic (client-side only)
    const el = id => document.getElementById(id);
    const analyzeBtn = el('analyzeBtn');
    const clearBtn = el('clearBtn');
    const aiAnswer = el('aiAnswer');
    const metrics = el('metrics');

    function prettyDuration(ms) {
      if (!ms || ms < 0) return '—';
      const s = Math.floor(ms/1000);
      const days = Math.floor(s / 86400);
      const hours = Math.floor((s % 86400) / 3600);
      const mins = Math.floor((s % 3600) / 60);
      const parts = [];
      if (days) parts.push(days + 'd');
      if (hours) parts.push(hours + 'h');
      if (mins) parts.push(mins + 'm');
      if (!parts.length) return '<1m';
      return parts.join(' ');
    }

    function numeric(v) { const n = Number(v); return Number.isFinite(n) ? n : null; }

    function simpleHeuristic(inputs) {
      // This is a deterministic, non-ML template that mimics an "AI answer" by
      // explaining the inputs and giving general guidance.
      const lines = [];
      lines.push(`<strong>Symbol:</strong> ${inputs.symbol || '—'}`);
      lines.push(`<strong>Market:</strong> ${inputs.market}`);
      lines.push(`<strong>Timeframe:</strong> ${inputs.timeframe}`);
      if (inputs.durationMs !== null) lines.push(`<strong>Estimated trade duration:</strong> ${prettyDuration(inputs.durationMs)}`);

      // Price-based metrics if provided
      if (inputs.entryPrice !== null && inputs.exitPrice !== null) {
        const pnl = (inputs.exitPrice - inputs.entryPrice) / inputs.entryPrice * 100;
        lines.push(`<strong>Raw return:</strong> ${pnl.toFixed(2)}%`);
      }

      if (inputs.sizeUsd !== null && inputs.entryPrice !== null && inputs.stopPrice !== null) {
        // rough risk% assuming stop distance
        const riskPerUnit = Math.abs(inputs.entryPrice - inputs.stopPrice);
        const estRiskUsd = (riskPerUnit / (inputs.entryPrice || 1)) * inputs.sizeUsd;
        const estRiskPct = (estRiskUsd / (inputs.sizeUsd || 1)) * 100;
        lines.push(`<strong>Est. risk (USD):</strong> ${estRiskUsd.toFixed(2)} USD`);
        lines.push(`<strong>Est. risk (% of position):</strong> ${estRiskPct.toFixed(2)}%`);
      }

      // Quick advice buckets (very generic)
      lines.push('<hr class="my-2 border-slate-600">');
      if (!inputs.entryTime || !inputs.exitTime) {
        lines.push('<em>Missing entry or exit time — give both to compute duration and timing advice.</em>');
      } else {
        // timing-based suggestion
        const durHours = inputs.durationMs / (1000*60*60);
        if (durHours < 1) lines.push('Short-term scalp. Focus on execution and tight stops.');
        else if (durHours < 24) lines.push('Intra-day trade. Watch key hourly levels and news during the day.');
        else lines.push('Swing/position trade. Consider higher timeframes and macro context.');
      }

      // Risk acceptance
      lines.push('<p class="mt-2">Remember: this analyzer is a helper — not a signal. Always size positions so a single loss doesn\'t blow your account.</p>');

      return lines.join('\n');
    }

    async function analyze() {
      const market = el('market').value;
      const symbol = el('symbol').value.trim().toUpperCase();
      const timeframe = el('timeframe').value;
      const entryTimeRaw = el('entryTime').value;
      const exitTimeRaw = el('exitTime').value;
      const entryPrice = numeric(el('entryPrice').value);
      const exitPrice = numeric(el('exitPrice').value);
      const stopPrice = numeric(el('stopPrice').value);
      const tpPrice = numeric(el('tpPrice').value);
      const sizeUsd = numeric(el('sizeUsd').value);
      const openAiKey = el('openAiKey').value.trim();

      let entryTime = entryTimeRaw ? new Date(entryTimeRaw) : null;
      let exitTime = exitTimeRaw ? new Date(exitTimeRaw) : null;
      let durationMs = null;
      if (entryTime && exitTime) {
        durationMs = exitTime - entryTime;
        if (isNaN(durationMs)) durationMs = null;
      }

      // update quick metrics
      const metricsEl = el('metrics');
      metricsEl.innerHTML = `
        <li><strong>Duration:</strong> ${durationMs !== null ? prettyDuration(durationMs) : '—'}</li>
        <li><strong>Potential P/L:</strong> ${ (entryPrice !== null && exitPrice !== null) ? ((exitPrice - entryPrice).toFixed(8) + ' (raw)') : '—'}</li>
        <li><strong>Risk / Reward:</strong> ${ (entryPrice !== null && stopPrice !== null && tpPrice !== null) ? ( Math.abs((tpPrice - entryPrice)/(entryPrice - stopPrice)).toFixed(2) + ':1' ) : '—'}</li>
      `;

      const inputs = { market, symbol, timeframe, entryTime, exitTime, durationMs, entryPrice, exitPrice, stopPrice, tpPrice, sizeUsd };

      // If user provided an OpenAI key, optionally call the API for a natural language answer.
      if (openAiKey) {
        aiAnswer.innerHTML = '<em>Contacting OpenAI for a detailed answer...</em>';
        try {
          // NOTE: Client-side calls with a secret key are visible in the browser and not recommended for production.
          // This example uses the Chat Completions API. Adjust model & endpoint as desired.
          const systemPrompt = `You are a concise trading assistant. Provide clear, actionable observations about this trade and note that you are not providing financial advice.`;
          const userPrompt = `Analyze this trade: ${JSON.stringify({symbol, market, timeframe, entryTime: entryTime?entryTime.toISOString():null, exitTime: exitTime?exitTime.toISOString():null, entryPrice, exitPrice, stopPrice, tpPrice, sizeUsd}, null, 2)}\nGive: (1) Short summary, (2) Key risks, (3) Suggested checks before entering.`;

          const resp = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + openAiKey
            },
            body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: userPrompt}], max_tokens: 600 })
          });

          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('OpenAI error: ' + resp.status + ' ' + txt);
          }
          const data = await resp.json();
          const content = data.choices && data.choices[0] && (data.choices[0].message?.content || data.choices[0].text) || 'No response.';
          aiAnswer.innerHTML = content.replace(/\n/g, '<br>');
        } catch (err) {
          aiAnswer.innerHTML = `<span class='text-amber-300'>OpenAI request failed:</span> ${err.message}`;
        }
        return;
      }

      // Otherwise use the simple heuristic template
      aiAnswer.innerHTML = simpleHeuristic(inputs);
    }

    analyzeBtn.addEventListener('click', async (e) => { e.preventDefault(); analyze(); });
    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      document.querySelectorAll('input').forEach(i => i.value = '');
      document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
      aiAnswer.innerHTML = 'Enter inputs and click <strong>Analyze</strong>.';
      metrics.innerHTML = '<li>Duration: —</li><li>Potential P/L: —</li><li>Risk / Reward: —</li>';
    });

  </script>
</body>
</html>
